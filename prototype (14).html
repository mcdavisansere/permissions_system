<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Permissions System</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  :root {
    --primary: #1a73e8;
    --primary-dark: #1558b0;
    --primary-light: #e8f0fe;
    --danger: #d93025;
    --danger-light: #fce8e6;
    --success: #188038;
    --success-light: #e6f4ea;
    --warning: #f29900;
    --warning-light: #fef7e0;
    --gray-50: #f8f9fa;
    --gray-100: #f1f3f4;
    --gray-200: #e8eaed;
    --gray-300: #dadce0;
    --gray-400: #bdc1c6;
    --gray-500: #9aa0a6;
    --gray-600: #80868b;
    --gray-700: #5f6368;
    --gray-800: #3c4043;
    --gray-900: #202124;
    --sidebar-width: 240px;
    --header-height: 60px;
    --font: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  body { font-family: var(--font); background: var(--gray-50); color: var(--gray-900); min-height: 100vh; }

  /* Header */
  .header {
    position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
    background: #fff; border-bottom: 1px solid var(--gray-200);
    display: flex; align-items: center; padding: 0 24px; z-index: 100;
    gap: 16px;
  }
  .header-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
  .logo-icon { width: 32px; height: 32px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
  .logo-icon svg { width: 18px; height: 18px; fill: white; }
  .logo-text { font-size: 18px; font-weight: 600; color: var(--gray-900); }
  .header-spacer { flex: 1; }
  .header-search {
    display: flex; align-items: center; gap: 8px;
    background: var(--gray-100); border: 1px solid transparent; border-radius: 24px;
    padding: 8px 16px; width: 280px; transition: all 0.2s;
  }
  .header-search:focus-within { background: #fff; border-color: var(--primary); }
  .header-search input { border: none; background: none; outline: none; font-size: 14px; width: 100%; color: var(--gray-900); }
  .header-search svg { width: 16px; height: 16px; fill: var(--gray-500); flex-shrink: 0; }
  .header-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; cursor: pointer; }

  /* Layout */
  .layout { display: flex; padding-top: var(--header-height); min-height: 100vh; }

  /* Sidebar */
  .sidebar {
    width: var(--sidebar-width); position: fixed; top: var(--header-height); left: 0; bottom: 0;
    background: #fff; border-right: 1px solid var(--gray-200); overflow-y: auto;
    padding: 16px 0;
  }
  .sidebar-section { margin-bottom: 8px; }
  .sidebar-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--gray-500); padding: 8px 16px 4px; }
  .sidebar-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 16px; cursor: pointer; border-radius: 0 24px 24px 0; margin-right: 8px;
    font-size: 14px; color: var(--gray-700); transition: all 0.15s; text-decoration: none;
  }
  .sidebar-item:hover { background: var(--gray-100); }
  .sidebar-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
  .sidebar-item svg { width: 18px; height: 18px; fill: currentColor; flex-shrink: 0; }
  .sidebar-badge { margin-left: auto; background: var(--primary); color: white; border-radius: 12px; padding: 1px 8px; font-size: 11px; font-weight: 600; }

  /* Main content */
  .main { margin-left: var(--sidebar-width); flex: 1; padding: 24px; min-height: 100vh; }

  /* Page header */
  .page-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
  .page-title { font-size: 22px; font-weight: 600; color: var(--gray-900); }
  .page-header-actions { margin-left: auto; display: flex; gap: 10px; }

  /* Buttons */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500;
    cursor: pointer; border: none; transition: all 0.15s; font-family: var(--font);
  }
  .btn svg { width: 16px; height: 16px; fill: currentColor; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: var(--primary-dark); }
  .btn-outline { background: #fff; color: var(--gray-700); border: 1px solid var(--gray-300); }
  .btn-outline:hover { background: var(--gray-50); border-color: var(--gray-400); }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { background: #c62828; }
  .btn-sm { padding: 5px 12px; font-size: 13px; }
  .btn-icon { padding: 7px; border-radius: 6px; }

  /* Tabs */
  .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--gray-200); margin-bottom: 24px; }
  .tab {
    padding: 10px 20px; font-size: 14px; font-weight: 500; cursor: pointer;
    border-bottom: 2px solid transparent; color: var(--gray-600); transition: all 0.15s;
    margin-bottom: -1px;
  }
  .tab:hover { color: var(--primary); }
  .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

  /* Cards */
  .card { background: #fff; border: 1px solid var(--gray-200); border-radius: 8px; }
  .card-header { padding: 16px 20px; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; gap: 12px; }
  .card-title { font-size: 15px; font-weight: 600; color: var(--gray-900); }
  .card-body { padding: 0; }

  /* Tables */
  .table-container { overflow-x: auto; border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; }
  th { padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-600); background: var(--gray-50); border-bottom: 1px solid var(--gray-200); white-space: nowrap; }
  td { padding: 13px 16px; font-size: 14px; color: var(--gray-800); border-bottom: 1px solid var(--gray-100); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--gray-50); }

  /* Badges */
  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
  .badge-success { background: var(--success-light); color: var(--success); }
  .badge-danger { background: var(--danger-light); color: var(--danger); }
  .badge-warning { background: var(--warning-light); color: #b06000; }
  .badge-neutral { background: var(--gray-100); color: var(--gray-600); }
  .badge-primary { background: var(--primary-light); color: var(--primary); }
  .badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

  /* Role cards */
  .roles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .role-card { background: #fff; border: 1px solid var(--gray-200); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.15s; position: relative; }
  .role-card:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(26,115,232,0.1); }
  .role-card.selected { border-color: var(--primary); background: var(--primary-light); }
  .role-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .role-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
  .role-icon svg { width: 20px; height: 20px; fill: white; }
  .role-name { font-size: 15px; font-weight: 600; color: var(--gray-900); }
  .role-count { font-size: 12px; color: var(--gray-500); margin-top: 2px; }
  .role-card-body { font-size: 13px; color: var(--gray-600); line-height: 1.5; margin-bottom: 12px; }
  .role-card-footer { display: flex; align-items: center; justify-content: space-between; }
  .role-permissions-count { font-size: 12px; color: var(--gray-500); }

  /* Permissions matrix */
  .perm-matrix { overflow-x: auto; }
  .perm-table { width: 100%; border-collapse: collapse; }
  .perm-table th, .perm-table td { padding: 10px 14px; border-bottom: 1px solid var(--gray-100); border-right: 1px solid var(--gray-100); }
  .perm-table th { background: var(--gray-50); font-size: 12px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
  .perm-table td:first-child { font-size: 13px; font-weight: 500; color: var(--gray-800); min-width: 200px; }
  .perm-table tr:last-child td { border-bottom: none; }
  .perm-check { display: flex; justify-content: center; }
  .perm-check input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary); }

  /* Toggle */
  .toggle { position: relative; display: inline-block; width: 40px; height: 22px; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; inset: 0; background: var(--gray-300); border-radius: 22px; cursor: pointer; transition: 0.2s; }
  .toggle-slider:before { content: ''; position: absolute; width: 16px; height: 16px; left: 3px; top: 3px; background: white; border-radius: 50%; transition: 0.2s; }
  .toggle input:checked + .toggle-slider { background: var(--primary); }
  .toggle input:checked + .toggle-slider:before { transform: translateX(18px); }

  /* Stats row */
  .stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: #fff; border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px 20px; }
  .stat-value { font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px; }
  .stat-label { font-size: 13px; color: var(--gray-500); }
  .stat-change { font-size: 12px; margin-top: 6px; }
  .stat-change.up { color: var(--success); }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: #fff; border-radius: 12px; width: 520px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 40px rgba(0,0,0,0.18); }
  .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; gap: 12px; }
  .modal-title { font-size: 17px; font-weight: 600; color: var(--gray-900); flex: 1; }
  .modal-close { width: 32px; height: 32px; border-radius: 6px; border: none; background: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 18px; }
  .modal-close:hover { background: var(--gray-100); }
  .modal-body { padding: 24px; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; gap: 10px; justify-content: flex-end; }

  /* Form */
  .form-group { margin-bottom: 18px; }
  .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--gray-700); margin-bottom: 6px; }
  .form-control { width: 100%; padding: 9px 12px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 14px; font-family: var(--font); color: var(--gray-900); outline: none; transition: border-color 0.15s; background: #fff; }
  .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,115,232,0.1); }
  .form-control::placeholder { color: var(--gray-400); }
  select.form-control { cursor: pointer; }

  /* User avatar */
  .user-cell { display: flex; align-items: center; gap: 10px; }
  .user-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: white; flex-shrink: 0; }
  .user-name { font-size: 14px; font-weight: 500; color: var(--gray-900); }
  .user-email { font-size: 12px; color: var(--gray-500); }

  /* Action menu */
  .action-btn { background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 4px; color: var(--gray-500); font-size: 18px; display: flex; align-items: center; }
  .action-btn:hover { background: var(--gray-100); color: var(--gray-700); }
  .actions-cell { display: flex; gap: 4px; align-items: center; }

  /* Alert */
  .alert { padding: 12px 16px; border-radius: 6px; font-size: 13px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
  .alert-success { background: var(--success-light); color: var(--success); border: 1px solid #a8d5b5; }
  .alert-info { background: var(--primary-light); color: var(--primary-dark); border: 1px solid #a8c7fa; }

  /* Audit log */
  .audit-item { padding: 14px 20px; border-bottom: 1px solid var(--gray-100); display: flex; gap: 14px; align-items: flex-start; }
  .audit-item:last-child { border-bottom: none; }
  .audit-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .audit-icon svg { width: 16px; height: 16px; fill: white; }
  .audit-content { flex: 1; }
  .audit-title { font-size: 14px; color: var(--gray-900); margin-bottom: 2px; }
  .audit-title strong { font-weight: 600; }
  .audit-meta { font-size: 12px; color: var(--gray-500); }
  .audit-time { font-size: 12px; color: var(--gray-400); white-space: nowrap; }

  /* Filter bar */
  .filter-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
  .filter-select { padding: 7px 12px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px; color: var(--gray-700); background: #fff; cursor: pointer; outline: none; font-family: var(--font); }
  .filter-select:focus { border-color: var(--primary); }
  .filter-count { font-size: 13px; color: var(--gray-500); margin-left: auto; }

  /* Notification */
  .toast {
    position: fixed; bottom: 24px; right: 24px; z-index: 300;
    background: var(--gray-900); color: white; padding: 12px 20px; border-radius: 8px;
    font-size: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    transform: translateY(80px); opacity: 0; transition: all 0.3s;
    display: flex; align-items: center; gap: 10px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* Section heading inside main */
  .section-title { font-size: 16px; font-weight: 600; color: var(--gray-900); margin-bottom: 12px; }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); transition: transform 0.25s; }
    .sidebar.open { transform: none; }
    .main { margin-left: 0; padding: 16px; }
    .roles-grid { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
  }

  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <a class="header-logo" href="#">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
    </div>
    <span class="logo-text">PermVault</span>
  </a>
  <div class="header-search">
    <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
    <input type="text" placeholder="Search users, roles, permissions..." id="globalSearch">
  </div>
  <div class="header-spacer"></div>
  <div class="header-avatar" title="Admin User">A</div>
</header>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-label">Overview</div>
    <a class="sidebar-item active" data-view="users" onclick="switchView('users', this)">
      <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
      Users
      <span class="sidebar-badge">24</span>
    </a>
    <a class="sidebar-item" data-view="roles" onclick="switchView('roles', this)">
      <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
      Roles
    </a>
    <a class="sidebar-item" data-view="permissions" onclick="switchView('permissions', this)">
      <svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
      Permissions
    </a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-label">Activity</div>
    <a class="sidebar-item" data-view="audit" onclick="switchView('audit', this)">
      <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
      Audit Log
      <span class="sidebar-badge" style="background:var(--warning);color:#fff;">3</span>
    </a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-label">Settings</div>
    <a class="sidebar-item" onclick="showToast('Settings coming soon')">
      <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
      System Settings
    </a>
  </div>
</nav>

<!-- Main Content -->
<main class="main">

  <!-- ===== USERS VIEW ===== -->
  <div id="view-users">
    <div class="page-header">
      <div>
        <div class="page-title">User Management</div>
      </div>
      <div class="page-header-actions">
        <button class="btn btn-outline" onclick="exportData()">
          <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          Export
        </button>
        <button class="btn btn-primary" onclick="openModal('addUserModal')">
          <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          Add User
        </button>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-value">24</div>
        <div class="stat-label">Total Users</div>
        <div class="stat-change up">↑ 3 this month</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">19</div>
        <div class="stat-label">Active</div>
        <div class="stat-change up">↑ 2 this week</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">5</div>
        <div class="stat-label">Pending Invite</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">6</div>
        <div class="stat-label">Roles Defined</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <svg style="width:18px;height:18px;fill:var(--gray-500)" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        <span class="card-title">All Users</span>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
          <select class="filter-select" onchange="filterUsers(this.value)">
            <option value="">All Roles</option>
            <option value="Admin">Admin</option>
            <option value="Editor">Editor</option>
            <option value="Viewer">Viewer</option>
            <option value="Manager">Manager</option>
            <option value="Developer">Developer</option>
          </select>
          <select class="filter-select" onchange="filterUserStatus(this.value)">
            <option value="">All Status</option>
            <option value="Approved">Approved</option>
            <option value="Pending">Pending</option>
            <option value="Denied">Denied</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table id="usersTable">
            <thead>
              <tr>
                <th>User</th>
                <th>Role</th>
                <th>Department</th>
                <th>Status</th>
                <th>Last Active</th>
                <th>2FA</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ROLES VIEW ===== -->
  <div id="view-roles" class="hidden">
    <div class="page-header">
      <div class="page-title">Roles</div>
      <div class="page-header-actions">
        <button class="btn btn-primary" onclick="openModal('addRoleModal')">
          <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          Create Role
        </button>
      </div>
    </div>

    <div class="alert alert-info">
      <svg style="width:18px;height:18px;fill:var(--primary);flex-shrink:0" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
      Roles define what users can do in the system. Assign users to roles to grant them the appropriate permissions.
    </div>

    <div class="roles-grid" id="rolesGrid"></div>
  </div>

  <!-- ===== PERMISSIONS VIEW ===== -->
  <div id="view-permissions" class="hidden">
    <div class="page-header">
      <div class="page-title">Permissions Matrix</div>
      <div class="page-header-actions">
        <button class="btn btn-outline" onclick="resetPermissions()">Reset</button>
        <button class="btn btn-primary" onclick="savePermissions()">
          <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
          Save Changes
        </button>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">Permission Assignment by Role</span>
      </div>
      <div class="card-body perm-matrix" id="permMatrix"></div>
    </div>
  </div>

  <!-- ===== AUDIT LOG VIEW ===== -->
  <div id="view-audit" class="hidden">
    <div class="page-header">
      <div class="page-title">Audit Log</div>
      <div class="page-header-actions">
        <button class="btn btn-outline" onclick="exportData()">
          <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          Export
        </button>
      </div>
    </div>

    <div class="filter-bar">
      <select class="filter-select">
        <option>All Actions</option>
        <option>User Created</option>
        <option>Role Changed</option>
        <option>Permission Modified</option>
        <option>Login</option>
        <option>Logout</option>
      </select>
      <select class="filter-select">
        <option>All Users</option>
        <option>Sarah Chen</option>
        <option>Marcus Johnson</option>
        <option>Priya Sharma</option>
      </select>
      <select class="filter-select">
        <option>Last 7 days</option>
        <option>Last 30 days</option>
        <option>Last 90 days</option>
        <option>Custom range</option>
      </select>
      <span class="filter-count" id="auditCount">Showing 12 events</span>
    </div>

    <div class="card">
      <div class="card-body" id="auditLog"></div>
    </div>
  </div>

</main>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Add User Modal -->
<div class="modal-overlay" id="addUserModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Add New User</span>
      <button class="modal-close" onclick="closeModal('addUserModal')">×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input type="text" class="form-control" placeholder="e.g. Jane Doe" id="newUserName">
      </div>
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input type="email" class="form-control" placeholder="jane@company.com" id="newUserEmail">
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select class="form-control" id="newUserRole">
          <option>Viewer</option>
          <option>Editor</option>
          <option>Manager</option>
          <option>Developer</option>
          <option>Admin</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Department</label>
        <select class="form-control" id="newUserDept">
          <option>Engineering</option>
          <option>Marketing</option>
          <option>Finance</option>
          <option>Operations</option>
          <option>HR</option>
          <option>Product</option>
        </select>
      </div>
      <div class="form-group" style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <label class="form-label" style="margin:0">Send invite email</label>
          <div style="font-size:12px;color:var(--gray-500)">User will receive setup instructions</div>
        </div>
        <label class="toggle">
          <input type="checkbox" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('addUserModal')">Cancel</button>
      <button class="btn btn-primary" onclick="addUser()">Add User</button>
    </div>
  </div>
</div>

<!-- Add Role Modal -->
<div class="modal-overlay" id="addRoleModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Create New Role</span>
      <button class="modal-close" onclick="closeModal('addRoleModal')">×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Role Name</label>
        <input type="text" class="form-control" placeholder="e.g. Content Moderator" id="newRoleName">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-control" rows="3" placeholder="Describe what this role can do..." id="newRoleDesc" style="resize:vertical"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Base Permissions on</label>
        <select class="form-control">
          <option>Start from scratch</option>
          <option>Copy from Viewer</option>
          <option>Copy from Editor</option>
          <option>Copy from Manager</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('addRoleModal')">Cancel</button>
      <button class="btn btn-primary" onclick="addRole()">Create Role</button>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal-overlay" id="editUserModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Edit User</span>
      <button class="modal-close" onclick="closeModal('editUserModal')">×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input type="text" class="form-control" id="editUserName">
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select class="form-control" id="editUserRole">
          <option>Viewer</option>
          <option>Editor</option>
          <option>Manager</option>
          <option>Developer</option>
          <option>Admin</option>
          <option>Super Admin</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-control" id="editUserStatus">
          <option>Approved</option>
          <option>Pending</option>
          <option>Denied</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="deleteUser()">Delete User</button>
      <div style="flex:1"></div>
      <button class="btn btn-outline" onclick="closeModal('editUserModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveUser()">Save Changes</button>
    </div>
  </div>
</div>

<script>
  // ─── Data ───────────────────────────────────────────────────────────────────
  const avatarColors = ['#1a73e8','#e53935','#43a047','#8e24aa','#fb8c00','#00897b','#d81b60','#3949ab'];

  let users = [
    { id:1, name:'Sarah Chen', email:'sarah.chen@company.com', role:'Admin', dept:'Engineering', status:'Approved', lastActive:'2 min ago', twoFA:true },
    { id:2, name:'Marcus Johnson', email:'marcus.j@company.com', role:'Manager', dept:'Operations', status:'Approved', lastActive:'1 hr ago', twoFA:true },
    { id:3, name:'Priya Sharma', email:'priya.sharma@company.com', role:'Developer', dept:'Engineering', status:'Approved', lastActive:'3 hr ago', twoFA:false },
    { id:4, name:'Luke Müller', email:'luke.m@company.com', role:'Editor', dept:'Marketing', status:'Approved', lastActive:'Yesterday', twoFA:true },
    { id:5, name:'Amara Diallo', email:'amara.d@company.com', role:'Viewer', dept:'Finance', status:'Denied', lastActive:'5 days ago', twoFA:false },
    { id:6, name:'James Park', email:'james.park@company.com', role:'Editor', dept:'Product', status:'Approved', lastActive:'Just now', twoFA:true },
    { id:7, name:'Fatima Al-Hassan', email:'fatima.h@company.com', role:'Manager', dept:'HR', status:'Approved', lastActive:'2 days ago', twoFA:false },
    { id:8, name:'David Torres', email:'d.torres@company.com', role:'Viewer', dept:'Finance', status:'Pending', lastActive:'Never', twoFA:false },
    { id:9, name:'Mei Ling', email:'mei.ling@company.com', role:'Developer', dept:'Engineering', status:'Approved', lastActive:'30 min ago', twoFA:true },
    { id:10, name:'Oliver Schmidt', email:'o.schmidt@company.com', role:'Viewer', dept:'Marketing', status:'Pending', lastActive:'Never', twoFA:false },
  ];

  let roles = [
    { name:'Super Admin', color:'#d93025', icon:'M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z', desc:'Full system access with no restrictions. Can manage all users, roles, and system settings.', users:1, perms:28 },
    { name:'Admin', color:'#1a73e8', icon:'M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z', desc:'Manage users, assign roles, and configure settings. Cannot modify billing or delete the organization.', users:1, perms:24 },
    { name:'Manager', color:'#8e24aa', icon:'M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z', desc:'Oversee team operations, approve workflows, and generate reports. Limited configuration access.', users:2, perms:16 },
    { name:'Developer', color:'#00897b', icon:'M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z', desc:'Access development tools, deploy builds, view logs and metrics. Can modify code and configurations.', users:2, perms:18 },
    { name:'Editor', color:'#fb8c00', icon:'M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z', desc:'Create, edit, and publish content. Cannot delete resources or manage users.', users:2, perms:12 },
    { name:'Viewer', color:'#9aa0a6', icon:'M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z', desc:'Read-only access to resources. Cannot create, edit, or delete any data.', users:3, perms:6 },
  ];

  const permResources = [
    'Users', 'Roles', 'Projects', 'Reports', 'Billing', 'Settings', 'Analytics', 'API Keys'
  ];
  const permActions = ['Create', 'Read', 'Update', 'Delete'];
  const roleNames = ['Admin', 'Manager', 'Developer', 'Editor', 'Viewer'];

  // Default permissions matrix (role → resource → action → bool)
  const defaultPerms = {
    'Admin':     { 'Users':[true,true,true,true],    'Roles':[true,true,true,false],  'Projects':[true,true,true,true],  'Reports':[true,true,true,false], 'Billing':[false,true,false,false], 'Settings':[true,true,true,false], 'Analytics':[true,true,false,false], 'API Keys':[true,true,true,true] },
    'Manager':   { 'Users':[false,true,true,false],  'Roles':[false,true,false,false],'Projects':[true,true,true,false], 'Reports':[true,true,false,false],'Billing':[false,true,false,false], 'Settings':[false,true,false,false],'Analytics':[false,true,false,false],'API Keys':[false,false,false,false] },
    'Developer': { 'Users':[false,true,false,false], 'Roles':[false,true,false,false],'Projects':[true,true,true,false], 'Reports':[false,true,false,false],'Billing':[false,false,false,false],'Settings':[false,false,false,false],'Analytics':[true,true,false,false],'API Keys':[true,true,false,false] },
    'Editor':    { 'Users':[false,true,false,false], 'Roles':[false,true,false,false],'Projects':[true,true,true,false], 'Reports':[false,true,false,false],'Billing':[false,false,false,false],'Settings':[false,false,false,false],'Analytics':[false,true,false,false],'API Keys':[false,false,false,false] },
    'Viewer':    { 'Users':[false,true,false,false], 'Roles':[false,true,false,false],'Projects':[false,true,false,false],'Reports':[false,true,false,false],'Billing':[false,false,false,false],'Settings':[false,false,false,false],'Analytics':[false,true,false,false],'API Keys':[false,false,false,false] },
  };
  let currentPerms = JSON.parse(JSON.stringify(defaultPerms));

  const auditEvents = [
    { type:'warn', icon:'M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z', color:'#d93025', title:'<strong>Sarah Chen</strong> modified permissions for <strong>Developer</strong> role', meta:'IP: 192.168.1.42 · Browser: Chrome 121', time:'2 min ago' },
    { type:'info', icon:'M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z', color:'#1a73e8', title:'<strong>Marcus Johnson</strong> invited <strong>Oliver Schmidt</strong> as Viewer', meta:'IP: 10.0.0.15 · Browser: Firefox 122', time:'47 min ago' },
    { type:'success', icon:'M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z', color:'#188038', title:'<strong>Priya Sharma</strong> logged in successfully', meta:'IP: 203.0.113.5 · Browser: Safari 17', time:'1 hr ago' },
    { type:'info', icon:'M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z', color:'#fb8c00', title:'<strong>Luke Müller</strong> updated project <strong>Alpha Launch</strong>', meta:'IP: 172.16.0.8 · Browser: Chrome 121', time:'2 hr ago' },
    { type:'warn', icon:'M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z', color:'#f29900', title:'<strong>System</strong> detected 3 failed login attempts for <strong>Amara Diallo</strong>', meta:'IP: 198.51.100.23 · Multiple attempts blocked', time:'3 hr ago' },
    { type:'info', icon:'M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z', color:'#8e24aa', title:'<strong>Sarah Chen</strong> created new role <strong>Content Reviewer</strong>', meta:'IP: 192.168.1.42 · Browser: Chrome 121', time:'Yesterday, 4:32 PM' },
    { type:'danger', icon:'M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12z', color:'#d93025', title:'<strong>Marcus Johnson</strong> removed <strong>Ben Williams</strong> from the system', meta:'IP: 10.0.0.15 · Action logged and reviewed', time:'Yesterday, 2:15 PM' },
    { type:'success', icon:'M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z', color:'#188038', title:'<strong>James Park</strong> published report <strong>Q4 Summary</strong>', meta:'IP: 10.0.0.22 · Browser: Edge 121', time:'2 days ago' },
    { type:'info', icon:'M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z', color:'#00897b', title:'<strong>Mei Ling</strong> enabled two-factor authentication', meta:'IP: 203.0.113.11 · Security improvement', time:'2 days ago' },
    { type:'info', icon:'M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z', color:'#3949ab', title:'<strong>Fatima Al-Hassan</strong> changed <strong>David Torres</strong> role from Viewer to Editor', meta:'IP: 10.0.0.88 · Approved by Admin', time:'3 days ago' },
    { type:'success', icon:'M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z', color:'#188038', title:'<strong>System</strong> completed scheduled permission audit', meta:'24 users, 6 roles reviewed — No violations found', time:'4 days ago' },
    { type:'info', icon:'M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z', color:'#1a73e8', title:'<strong>Sarah Chen</strong> exported user list', meta:'IP: 192.168.1.42 · 24 records exported', time:'5 days ago' },
  ];

  let editingUserId = null;
  let currentRoleFilter = '';
  let currentStatusFilter = '';

  // ─── Render Users ────────────────────────────────────────────────────────────
  function getInitials(name) { return name.split(' ').map(p=>p[0]).join('').toUpperCase().slice(0,2); }
  function getAvatarColor(name) { let h=0; for(let c of name) h+=c.charCodeAt(0); return avatarColors[h%avatarColors.length]; }

  function statusBadge(s) {
    const map = { Approved:'badge-success', Denied:'badge-danger', Pending:'badge-warning' };
    return `<span class="badge ${map[s]||'badge-neutral'}">${s}</span>`;
  }

  function renderUsers() {
    const tbody = document.getElementById('usersTableBody');
    let filtered = users.filter(u => {
      if (currentRoleFilter && u.role !== currentRoleFilter) return false;
      if (currentStatusFilter && u.status !== currentStatusFilter) return false;
      return true;
    });
    if (filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:32px;color:var(--gray-500)">No users match the current filters.</td></tr>`;
      return;
    }
    tbody.innerHTML = filtered.map(u => `
      <tr>
        <td>
          <div class="user-cell">
            <div class="user-avatar" style="background:${getAvatarColor(u.name)}">${getInitials(u.name)}</div>
            <div>
              <div class="user-name">${u.name}</div>
              <div class="user-email">${u.email}</div>
            </div>
          </div>
        </td>
        <td><span class="badge badge-primary" style="background:${getAvatarColor(u.role)}18;color:${getAvatarColor(u.role)}">${u.role}</span></td>
        <td style="color:var(--gray-600)">${u.dept}</td>
        <td>${statusBadge(u.status)}</td>
        <td style="color:var(--gray-500);font-size:13px">${u.lastActive}</td>
        <td>
          ${u.twoFA
            ? `<span style="color:var(--success);font-size:13px;font-weight:500">✓ On</span>`
            : `<span style="color:var(--gray-400);font-size:13px">Off</span>`}
        </td>
        <td>
          <div class="actions-cell">
            <button class="btn btn-outline btn-sm" onclick="openEditUser(${u.id})">Edit</button>
            <button class="action-btn" onclick="toggleUserStatus(${u.id})" title="${u.status==='Approved'?'Deny':'Approve'}">
              ${u.status==='Approved'
                ? `<svg style="width:16px;height:16px;fill:var(--warning)" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`
                : `<svg style="width:16px;height:16px;fill:var(--success)" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>`
              }
            </button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function filterUsers(role) { currentRoleFilter = role; renderUsers(); }
  function filterUserStatus(status) { currentStatusFilter = status; renderUsers(); }

  // ─── Render Roles ────────────────────────────────────────────────────────────
  function renderRoles() {
    const grid = document.getElementById('rolesGrid');
    grid.innerHTML = roles.map(r => `
      <div class="role-card" onclick="switchView('permissions', document.querySelector('[data-view=permissions]'))">
        <div class="role-card-header">
          <div class="role-icon" style="background:${r.color}">
            <svg viewBox="0 0 24 24"><path d="${r.icon}"/></svg>
          </div>
          <div>
            <div class="role-name">${r.name}</div>
            <div class="role-count">${r.users} ${r.users===1?'user':'users'}</div>
          </div>
        </div>
        <div class="role-card-body">${r.desc}</div>
        <div class="role-card-footer">
          <span class="role-permissions-count">${r.perms} permissions</span>
          <button class="btn btn-outline btn-sm" onclick="event.stopPropagation();showToast('Edit role: ${r.name}')">Edit</button>
        </div>
      </div>
    `).join('');
  }

  // ─── Render Permissions Matrix ───────────────────────────────────────────────
  function renderPermMatrix() {
    const el = document.getElementById('permMatrix');
    let html = `<table class="perm-table"><thead><tr><th>Resource / Permission</th>`;
    roleNames.forEach(r => { html += `<th colspan="${permActions.length}" style="text-align:center;background:${getAvatarColor(r)}18;color:${getAvatarColor(r)}">${r}</th>`; });
    html += `</tr><tr><th></th>`;
    roleNames.forEach(() => { permActions.forEach(a => { html += `<th style="text-align:center;font-size:10px">${a}</th>`; }); });
    html += `</tr></thead><tbody>`;
    permResources.forEach(res => {
      html += `<tr><td>${res}</td>`;
      roleNames.forEach(role => {
        permActions.forEach((act, ai) => {
          const checked = currentPerms[role]?.[res]?.[ai] ? 'checked' : '';
          html += `<td><div class="perm-check"><input type="checkbox" ${checked} onchange="togglePerm('${role}','${res}',${ai},this.checked)"></div></td>`;
        });
      });
      html += `</tr>`;
    });
    html += `</tbody></table>`;
    el.innerHTML = html;
  }

  function togglePerm(role, resource, actionIdx, val) {
    if (!currentPerms[role]) currentPerms[role] = {};
    if (!currentPerms[role][resource]) currentPerms[role][resource] = [false,false,false,false];
    currentPerms[role][resource][actionIdx] = val;
  }

  function savePermissions() { showToast('✓ Permissions saved successfully'); }
  function resetPermissions() { currentPerms = JSON.parse(JSON.stringify(defaultPerms)); renderPermMatrix(); showToast('Permissions reset to defaults'); }

  // ─── Render Audit Log ────────────────────────────────────────────────────────
  function renderAuditLog() {
    const el = document.getElementById('auditLog');
    el.innerHTML = auditEvents.map(e => `
      <div class="audit-item">
        <div class="audit-icon" style="background:${e.color}">
          <svg viewBox="0 0 24 24"><path d="${e.icon}"/></svg>
        </div>
        <div class="audit-content">
          <div class="audit-title">${e.title}</div>
          <div class="audit-meta">${e.meta}</div>
        </div>
        <div class="audit-time">${e.time}</div>
      </div>
    `).join('');
  }

  // ─── View Switching ──────────────────────────────────────────────────────────
  function switchView(view, el) {
    document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
    document.getElementById('view-' + view).classList.remove('hidden');
    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
    const target = el || document.querySelector(`[data-view="${view}"]`);
    if (target) target.classList.add('active');

    if (view === 'roles') renderRoles();
    if (view === 'permissions') renderPermMatrix();
    if (view === 'audit') renderAuditLog();
    if (view === 'users') renderUsers();
  }

  // ─── Modal helpers ───────────────────────────────────────────────────────────
  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  document.querySelectorAll('.modal-overlay').forEach(o => {
    o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
  });

  // ─── User Actions ────────────────────────────────────────────────────────────
  function addUser() {
    const name = document.getElementById('newUserName').value.trim();
    const email = document.getElementById('newUserEmail').value.trim();
    const role = document.getElementById('newUserRole').value;
    const dept = document.getElementById('newUserDept').value;
    if (!name || !email) { showToast('Please fill in all required fields'); return; }
    users.unshift({ id: Date.now(), name, email, role, dept, status:'Pending', lastActive:'Never', twoFA:false });
    renderUsers();
    closeModal('addUserModal');
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserEmail').value = '';
    showToast(`✓ Invitation sent to ${email}`);
  }

  function openEditUser(id) {
    const u = users.find(u => u.id === id);
    if (!u) return;
    editingUserId = id;
    document.getElementById('editUserName').value = u.name;
    document.getElementById('editUserRole').value = u.role;
    document.getElementById('editUserStatus').value = u.status;
    openModal('editUserModal');
  }

  function saveUser() {
    const u = users.find(u => u.id === editingUserId);
    if (!u) return;
    u.name = document.getElementById('editUserName').value;
    u.role = document.getElementById('editUserRole').value;
    u.status = document.getElementById('editUserStatus').value;
    renderUsers();
    closeModal('editUserModal');
    showToast(`✓ User updated successfully`);
  }

  function deleteUser() {
    users = users.filter(u => u.id !== editingUserId);
    renderUsers();
    closeModal('editUserModal');
    showToast('User removed from system');
  }

  function toggleUserStatus(id) {
    const u = users.find(u => u.id === id);
    if (!u) return;
    u.status = u.status === 'Approved' ? 'Denied' : 'Approved';
    renderUsers();
    showToast(`User ${u.status === 'Approved' ? 'approved' : 'denied'}`);
  }

  // ─── Role Actions ────────────────────────────────────────────────────────────
  function addRole() {
    const name = document.getElementById('newRoleName').value.trim();
    const desc = document.getElementById('newRoleDesc').value.trim();
    if (!name) { showToast('Please enter a role name'); return; }
    roles.push({ name, color: avatarColors[roles.length % avatarColors.length], icon:'M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z', desc: desc || 'Custom role.', users:0, perms:0 });
    closeModal('addRoleModal');
    document.getElementById('newRoleName').value = '';
    document.getElementById('newRoleDesc').value = '';
    renderRoles();
    showToast(`✓ Role "${name}" created`);
  }

  // ─── Toast ───────────────────────────────────────────────────────────────────
  let toastTimer;
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
  }

  // ─── Export ──────────────────────────────────────────────────────────────────
  function exportData() { showToast('✓ Export started — file will download shortly'); }

  // ─── Global Search ───────────────────────────────────────────────────────────
  document.getElementById('globalSearch').addEventListener('input', function() {
    const q = this.value.toLowerCase();
    if (!q) { renderUsers(); return; }
    const tbody = document.getElementById('usersTableBody');
    const filtered = users.filter(u => u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q) || u.role.toLowerCase().includes(q));
    if (document.getElementById('view-users').classList.contains('hidden')) return;
    if (filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:32px;color:var(--gray-500)">No results for "${this.value}"</td></tr>`;
    } else {
      const saved = users; users = filtered; renderUsers(); users = saved;
    }
  });

  // ─── Init ────────────────────────────────────────────────────────────────────
  renderUsers();
</script>
</body>
</html>